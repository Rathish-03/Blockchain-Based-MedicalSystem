import React, { useState, useEffect } from 'react';
import { ethers } from 'ethers';
import HealthcareRecords from "./contracts/HealthcareRecords.json";

const Healthcare = () => {
  const [provider, setProvider] = useState(null);
  const [signer, setSigner] = useState(null);
  const [contract, setContract] = useState(null);
  const [account, setAccount] = useState(null);
  const [isOwner, setIsOwner] = useState(null);
  const [patientID, setPatientID] = useState('');
  const [diagnosis, setDiagnosis] = useState('');
  const [treatment, setTreatment] = useState('');
  const [patientRecords, setPatientRecords] = useState([]);
  const [providerAddress, setProviderAddress] = useState("");

  useEffect(() => {
    const connectWallet = async () => {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = provider.getSigner();
        setProvider(provider);
        setSigner(signer);

        const accountAddress = await signer.getAddress();
        setAccount(accountAddress);

        console.log("Connected account:", accountAddress);

        const network = await provider.getNetwork();
        const networkId = network.chainId.toString(); // force string

        console.log("Connected to chainId:", network.chainId);
        console.log("Available deployments:", Object.keys(HealthcareRecords.networks));

        const deployedNetwork = HealthcareRecords.networks[networkId];

        if (!deployedNetwork) {
          alert(`Smart contract not deployed on chain ID ${networkId}`);
          return;
        }

        const contract = new ethers.Contract(
          deployedNetwork.address,
          HealthcareRecords.abi,
          signer
        );
        setContract(contract);

        const ownerAddress = await contract.getOwner();
        setIsOwner(accountAddress.toLowerCase() === ownerAddress.toLowerCase());

      } catch (error) {
        console.error("Error connecting to wallet: ", error);
      }
    };

    connectWallet();
  }, []);

  const fetchPatientRecords = async () => {
    try {
      setPatientRecords([]); // clear previous
      if (!patientID) {
        alert("Enter a patient ID first");
        return;
      }

      const records = await contract.getPatientRecords(patientID);
      console.log(records);
      setPatientRecords(records);
    } catch (error) {
      console.error("Error fetching patient records", error);
    }
  };

  const addRecord = async () => {
    try {
      if (!patientID || !diagnosis || !treatment) {
        alert("Please fill all fields");
        return;
      }

      const tx = await contract.addRecord(patientID, "Alice", diagnosis, treatment);
      await tx.wait();

      alert("Patient record added successfully");

      // reset inputs
      setDiagnosis("");
      setTreatment("");
      setPatientID("");
      setPatientRecords([]); // clear records after adding
    } catch (error) {
      console.error("Error adding records", error);
    }
  };
  const authorizeMyAccount = async () => {
    try {
      if (!contract) {
        alert("Contract not loaded yet");
        return;
      }

      const tx = await contract.authorizeProvider(account);
      await tx.wait();
      alert(`Your account (${account}) has been authorized as provider`);
    } catch (error) {
        console.error("Error authorizing account:", error);
        alert("Failed to authorize your account. Make sure you are contract owner.");
      }
};


  const authorizeProvider = async () => {
    if (isOwner) {
      try {
        if (!providerAddress) {
          alert("Enter a provider address");
          return;
        }
        const tx = await contract.authorizeProvider(providerAddress);
        await tx.wait();
        alert(`Provider ${providerAddress} authorized successfully`);
        setProviderAddress(""); // reset input
      } catch (error) {
        console.error("Only contract owner can authorize different providers");
      }
    } else {
      alert("Only contract owner can call this function");
    }
  };

  return (
    <div className='container'>
      <h1 className="title">HealthCare Application</h1>
      {account && <p className='account-info'>Connected Account: {account}</p>}
      {isOwner && <p className='owner-info'>You are the contract owner</p>}

      <div className='form-section'>
        <h2>Fetch Patient Records</h2>
        <input
          className='input-field'
          type='text'
          placeholder='Enter Patient ID'
          value={patientID}
          onChange={(e) => setPatientID(e.target.value)}
        />
        <button className='action-button' onClick={fetchPatientRecords}>Fetch Records</button>
      </div>

      <div className="form-section">
        <h2>Add Patient Record</h2>
        <input
          className='input-field'
          type='text'
          placeholder='Diagnosis'
          value={diagnosis}
          onChange={(e) => setDiagnosis(e.target.value)}
        />
        <input
          className='input-field'
          type='text'
          placeholder='Treatment'
          value={treatment}
          onChange={(e) => setTreatment(e.target.value)}
        />
        <button className='action-button' onClick={addRecord}>Add Records</button>
      </div>

      <div className="form-section">
        <h2>Authorize HealthCare Provider</h2>
        <input
          className='input-field'
          type="text"
          placeholder='Provider Address'
          value={providerAddress}
          onChange={(e) => setProviderAddress(e.target.value)}
        />
        <button className='action-button' onClick={authorizeProvider}>Authorize Provider</button>
      </div>
      <div className="form-section">
        <h2>Authorize Yourself</h2>
        <button className="action-button" onClick={authorizeMyAccount}>
            Authorize My Account
        </button>
      </div>

      

      <div className='records-section'>
        <h2>Patient Records</h2>
        {patientRecords.map((record, index) => (
            <div key={index}>
                <p>Patient ID: {record.patientID.toNumber()}</p>
                <p>Record ID: {record.recordID.toNumber()}</p>
                <p>Diagnosis: {record.diagnosis}</p>
                <p>Treatment: {record.treatment}</p>
                <p>Timestamp: {new Date(record.timestamp.toNumber() * 1000).toLocaleString()}</p>
            </div>
        ))}
      </div>

    </div>
  );
};

export default Healthcare;
